# Mosquitto configuration with TLS/SSL (MQTTS)
# PostgreSQL backend for authentication and ACL

# MQTT over TLS (port 8883)
listener 8883 0.0.0.0
protocol mqtt

# TLS Configuration
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# Require certificates from clients (set to false if using username/password only)
require_certificate false

# TLS version (1.2 minimum recommended)
tls_version tlsv1.2

# WebSockets over TLS (port 9002)
listener 9002 0.0.0.0
protocol websockets

# TLS for WebSockets
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key
require_certificate false
tls_version tlsv1.2

# Optional: Keep non-TLS listeners for local/testing
# listener 1883 127.0.0.1
# protocol mqtt

# Disable anonymous access (require authentication)
allow_anonymous false

# Logging
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information

# Load Go-Auth plugin
auth_plugin /mosquitto/go-auth.so

# Backend configuration - HTTP authentication
auth_opt_backends http

# HTTP backend settings
auth_opt_http_host host.docker.internal
auth_opt_http_port 4002
auth_opt_http_getuser_uri /mosquitto-auth/user
auth_opt_http_superuser_uri /mosquitto-auth/superuser
auth_opt_http_aclcheck_uri /mosquitto-auth/acl

# HTTP request configuration
auth_opt_http_method POST
auth_opt_http_request_type json
auth_opt_http_response_mode status
auth_opt_http_timeout 5

# Password hashing configuration
auth_opt_hasher bcrypt
auth_opt_hasher_cost 10

# Redis cache configuration
auth_opt_cache true
auth_opt_cache_type redis
auth_opt_cache_host redis
auth_opt_cache_port 6379
auth_opt_cache_db 1
auth_opt_auth_cache_seconds 300
auth_opt_acl_cache_seconds 300
auth_opt_auth_jitter_seconds 10
auth_opt_cache_reset true

# Logging
auth_opt_log_level info
auth_opt_log_dest stdout
