# Mosquitto configuration with Go-Auth plugin
# PostgreSQL backend for authentication and ACL

# Basic Mosquitto settings
listener 1883 0.0.0.0
protocol mqtt

listener 9001 0.0.0.0
protocol websockets

# Disable anonymous access (require authentication)
allow_anonymous false

# Logging
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_type debug

# Load Go-Auth plugin
auth_plugin /mosquitto/go-auth.so

# Backend configuration - HTTP authentication
# Uses API endpoints on port 4002 for authentication (not 3002)
auth_opt_backends http

# HTTP backend settings
# host.docker.internal allows container to reach host machine (Docker Desktop feature)
auth_opt_http_host host.docker.internal
auth_opt_http_port 4002
auth_opt_http_getuser_uri /mosquitto-auth/user
auth_opt_http_superuser_uri /mosquitto-auth/superuser
auth_opt_http_aclcheck_uri /mosquitto-auth/acl

# HTTP request configuration
auth_opt_http_method POST
auth_opt_http_request_type json
auth_opt_http_response_mode status

# HTTP timeout
auth_opt_http_timeout 5

# Password hashing configuration
# Note: Password validation is done by the API using bcrypt
auth_opt_hasher bcrypt
auth_opt_hasher_cost 10
# Redis cache configuration
# Enable caching to reduce API load
auth_opt_cache true

# Cache backend (redis)
auth_opt_cache_type redis

# Redis connection
auth_opt_cache_host redis
auth_opt_cache_port 6379
# auth_opt_cache_password <password>  
# Uncomment if Redis has password
# Use DB 1 for auth cache (DB 0 for application)
auth_opt_cache_db 1  

# Cache TTL settings (in seconds)
# User authentication cache: 5 minutes
auth_opt_auth_cache_seconds 300  
# ACL cache: 5 minutes    
auth_opt_acl_cache_seconds 300    
# Random jitter to prevent cache stampede    
auth_opt_auth_jitter_seconds 10      

# Cache reset behavior
# When true, clears cache on auth failure (prevents cached denials)
auth_opt_cache_reset true

# Logging level (debug for troubleshooting, change to info in production)
auth_opt_log_level debug
auth_opt_log_dest stdout
