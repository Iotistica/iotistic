# Docker Compose configuration for Cloud API and PostgreSQL backend
# 
# Usage:
#   docker-compose -f docker-compose.cloud.yml up -d
#
# This stack provides:
#   - PostgreSQL 16 database for persistent device state storage
#   - Iotistic API server with Balena-style endpoints
#
# Environment variables (configure in .env):
#   - DB_PASSWORD=<password>    # PostgreSQL password
#   - DB_PORT_EXT=5432          # External PostgreSQL port
#   - API_PORT_EXT=3002         # External API port
#   - GRAFANA_API_TOKEN=<token> # For Grafana integration

services:
    agent-1:
            container_name: agent-1
            build:
                context: ./agent
                dockerfile: Dockerfile
            restart: always
            # Memory limits for edge device testing (Raspberry Pi 4 = 2-4GB total RAM)
            # Allocate 512MB limit to simulate constrained environment
            mem_limit: 512m
            mem_reservation: 256m
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-1-data:/app/data
            environment:
                - AGENT_VERSION=1.0.0
                - DEVICE_API_PORT=48481
                - CLOUD_API_ENDPOINT=http://api:3002
                - NODE_ENV=development
                - FORCE_COLOR=1
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=7000
                - METRICS_INTERVAL_MS=20000
                - LOG_COMPRESSION=true
                - PROVISIONING_API_KEY=708b51cbc9b5b515151fbb943ba9788ab6885d037455424b290f97d2077ae8c0
                # API Security (change to test different modes)
                # Options: LOCALHOST_ONLY (default), LOCAL_NETWORK, API_KEY, OPEN
                - API_SECURITY_MODE=${API_SECURITY_MODE:-LOCALHOST_ONLY}
                - API_KEY=${API_KEY:-}
                # Memory monitoring (edge-appropriate thresholds)
                - MEMORY_CHECK_INTERVAL_MS=30000
                - MEMORY_THRESHOLD_MB=15
                # Data resilience (IoT best practices)
                - LOG_FILE_PERSISTANCE=true
                - LOG_MAX_AGE=86400000
                - MAX_LOG_FILE_SIZE=52428800
                - MAX_LOGS=10000
                # Memory leak simulation (for testing - disabled by default)
                - SIMULATE_MEMORY_LEAK=false
                - LEAK_TYPE=sudden
                - LEAK_RATE_MB=50
                - LEAK_INTERVAL_MS=2000
                - LEAK_MAX_MB=30
                - ANOMALY_DETECTION_ENABLED=true
                # NEW: Simulation mode (unified testing framework)
                - SIMULATION_MODE=true
                - SIMULATION_CONFIG={"scenarios":{"anomaly_injection":{"enabled":true,"metrics":["cpu_temp","memory_percent"],"pattern":"spike","intervalMs":30000,"magnitude":3},"sensor_data":{"enabled":true,"pattern":"realistic","publishIntervalMs":10000}}}
            depends_on:
                api:
                    condition: service_healthy
            networks:
                - iotistic-net
                
    agent-2:
            container_name: agent-2
            build:
                context: ./agent
                dockerfile: Dockerfile
            restart: always
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-2-data:/app/data
            environment:
                - AGENT_VERSION=1.0.0
                - DEVICE_API_PORT=48482
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=20000
                - METRICS_INTERVAL_MS=30000
                - LOG_COMPRESSION=true
                - REQUIRE_PROVISIONING=false
                - PROVISIONING_API_KEY=3045da51b7092a78bdcbae0c8e427cb60a9aa535b5e62856f03d297df57b1a28
                # Data resilience (IoT best practices)
                - LOG_FILE_PERSISTANCE=true
                - LOG_MAX_AGE=86400000
                - MAX_LOG_FILE_SIZE=52428800
                - MAX_LOGS=10000
                
            depends_on:
                api:
                    condition: service_healthy
            networks:
                - iotistic-net
    agent-3:
            container_name: agent-3
            build:
                context: ./agent
                dockerfile: Dockerfile
            restart: always
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-3-data:/app/data
            environment:
                - AGENT_VERSION=1.0.0
                - DEVICE_API_PORT=48483
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=20000
                - METRICS_INTERVAL_MS=30000
                - LOG_COMPRESSION=true
                - REQUIRE_PROVISIONING=false
                - PROVISIONING_API_KEY=3045da51b7092a78bdcbae0c8e427cb60a9aa535b5e62856f03d297df57b1a28
                # Data resilience (IoT best practices)
                - LOG_FILE_PERSISTANCE=true
                - LOG_MAX_AGE=86400000
                - MAX_LOG_FILE_SIZE=52428800
                - MAX_LOGS=10000
                
            depends_on:
                api:
                    condition: service_healthy
            networks:
                - iotistic-net
    agent-4:
            container_name: agent-4
            build:
                context: ./agent
                dockerfile: Dockerfile
            restart: always
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-4-data:/app/data
            environment:
                - AGENT_VERSION=1.0.0
                - DEVICE_API_PORT=48484
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=20000
                - METRICS_INTERVAL_MS=30000
                - LOG_COMPRESSION=true
                - REQUIRE_PROVISIONING=false
                - PROVISIONING_API_KEY=b3eef7b315d4f8bc4340a9349d6efa3f7da298657f7c89c651dd9a253d8bb7fe
                # Data resilience (IoT best practices)
                - LOG_FILE_PERSISTANCE=true
                - LOG_MAX_AGE=86400000
                - MAX_LOG_FILE_SIZE=52428800
                - MAX_LOGS=10000
                
                
            depends_on:
                api:
                    condition: service_healthy
            networks:
                - iotistic-net
    agent-5:
            container_name: agent-5
            build:
                context: ./agent
                dockerfile: Dockerfile
            restart: always
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-5-data:/app/data
            environment:
                - AGENT_VERSION=1.0.0
                - DEVICE_API_PORT=48485
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=20000
                - METRICS_INTERVAL_MS=30000
                - LOG_COMPRESSION=true
                - REQUIRE_PROVISIONING=false
                - PROVISIONING_API_KEY=aba83af8bddf79e3f79ed3fc2f7d450c86c72507c3b9194f3627508360c8c0b4
                # Data resilience (IoT best practices)
                - LOG_FILE_PERSISTANCE=true
                - LOG_MAX_AGE=86400000
                - MAX_LOG_FILE_SIZE=52428800
                - MAX_LOGS=10000
                
                
            depends_on:
                api:
                    condition: service_healthy
            networks:
                - iotistic-net
    agent-6:
            container_name: agent-6
            build:
                context: ./agent
                dockerfile: Dockerfile
            restart: always
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-6-data:/app/data
            environment:
                - AGENT_VERSION=1.0.0
                - DEVICE_API_PORT=48486
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=20000
                - METRICS_INTERVAL_MS=30000
                - LOG_COMPRESSION=true
                - REQUIRE_PROVISIONING=false
                - PROVISIONING_API_KEY=e0d409d6efe09f1fba3c0365a525de8949002072f0e48deacf247141826e6b83
                # Data resilience (IoT best practices)
                - LOG_FILE_PERSISTANCE=true
                - LOG_MAX_AGE=86400000
                - MAX_LOG_FILE_SIZE=52428800
                - MAX_LOGS=10000
                
                
            depends_on:
                api:
                    condition: service_healthy
            networks:
                - iotistic-net
    postgres:
        image: postgres:16-alpine
        container_name: iotistic-postgres
        restart: unless-stopped
        environment:
            - POSTGRES_DB=${POSTGRES_DB:-iotistic}
            - POSTGRES_USER=${POSTGRES_USER:-postgres}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
        ports:
            - "5432:5432"
        volumes:
            - iotistic-pg-data:/var/lib/postgresql/data
            - ./postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
            - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
        command: >
            postgres
            -c config_file=/etc/postgresql/postgresql.conf
            -c hba_file=/etc/postgresql/pg_hba.conf
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
           - iotistic-net

    redis:
        image: redis:7-alpine
        container_name: iotistic-redis
        restart: unless-stopped
        command: >
            redis-server
            --maxmemory 256mb
            --maxmemory-policy volatile-lru
            --save 60 1000
            --appendonly yes
        ports:
            - "${REDIS_PORT_EXT:-6379}:6379"
        volumes:
            - iotistic-redis-data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
           - iotistic-net

    api:
        build:
            context: ./api
            dockerfile: Dockerfile
        container_name: iotistic-api
        restart: always
        tty: true
        stdin_open: true
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        environment:
            - PORT=${PORT:-3002}
            - NODE_ENV=${NODE_ENV:-development}
            - DB_HOST=${DB_HOST:-postgres}
            - DB_PORT=${DB_PORT:-5432}
            - DB_NAME=${DB_NAME:-iotistic}
            - DB_USER=${DB_USER:-postgres}
            - DB_PASSWORD=${DB_PASSWORD:-postgres}
            - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
            - FORCE_COLOR=${FORCE_COLOR:-1}
            - MQTT_BROKER_URL=${MQTT_BROKER_URL:-mqtt://mosquitto:1883}
            - MQTT_USERNAME=${MQTT_USERNAME:-admin}
            - MQTT_PASSWORD=${MQTT_PASSWORD:-iotistic42!}
            - MQTT_PERSIST_TO_DB=${MQTT_PERSIST_TO_DB:-true}
            - MQTT_DB_SYNC_INTERVAL=${MQTT_DB_SYNC_INTERVAL:-10000}
            - MQTT_MONITOR_ENABLED=${MQTT_MONITOR_ENABLED:-true}
            - LOG_COMPRESSION=${LOG_COMPRESSION:-true}
            - LICENSE_PUBLIC_KEY=${LICENSE_PUBLIC_KEY}
            - IOTISTIC_LICENSE_KEY=${IOTISTIC_LICENSE_KEY}
            - REDIS_HOST=${REDIS_HOST:-redis}
            - REDIS_PORT=${REDIS_PORT:-6379}
            - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
            - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
            - NEO4J_PASSWORD=${NEO4J_PASSWORD:-iotistic123}
            - VPN_ENABLED=true
            - WG_SERVER_URL=http://wg-server:8089
            - VPN_SERVER_ENDPOINT=${VPN_SERVER_ENDPOINT:-vpn.example.com}
            - VPN_SERVER_PORT=51820
        ports:
            - "${API_PORT_EXT:-4002}:3002"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
           - iotistic-net
    mosquitto:
        image: iegomez/mosquitto-go-auth
        restart: always
        container_name: iotistic-mosquitto
        ports:
          - "${MOSQUITTO_PORT_EXT:-5883}:1883"        # Non-TLS (local)
          - "${MOSQUITTO_WS_PORT_EXT:-59002}:9001"    # WebSocket non-TLS
          - "${MOSQUITTO_TLS_PORT_EXT:-8883}:8883"    # MQTTS (TLS)
          - "${MOSQUITTO_WSS_PORT_EXT:-9002}:9002"    # WebSocket TLS
        volumes:
          - ./mosquitto/mosquitto.conf:/etc/mosquitto/mosquitto.conf
          - ./certs:/mosquitto/certs:ro  # Mount certificates (read-only)
        depends_on:
            postgres:
                condition: service_healthy
        networks:
           - iotistic-net
    

    # VPN Services - Commented out until TypeScript code is complete
    # Missing: vpn-server/src/vpn-server.ts implementation
    # TODO: Complete VPN server implementation before enabling
    # vpn-server:
    #     build:
    #         context: ./vpn-server
    #         dockerfile: Dockerfile
    #     container_name: iotistic-vpn-server
    #     privileged: true
    #     cap_add:
    #         - NET_ADMIN
    #         - SYS_MODULE
    #     restart: unless-stopped
    #     ports:
    #         - "${VPN_SERVER_PORT:-1194}:1194/udp"  # OpenVPN
    #         - "${VPN_API_PORT:-3200}:3200/tcp"      # API Server
    #         - "${VPN_MGMT_PORT:-7505}:7505/tcp"     # Management interface
    #         - "${VPN_CA_PORT:-8080}:8080/tcp"       # CA Certificate Server
    #     volumes:
    #         - vpn-config:/etc/openvpn
    #         - vpn-logs:/var/log/openvpn
    #         - ./vpn-server/config:/etc/openvpn/config:ro
    #         - ./vpn-server/scripts:/etc/openvpn/scripts:ro
    #     environment:
    #         - VPN_SERVER_HOST=${VPN_SERVER_HOST:-localhost}
    #         - VPN_SERVER_PORT=${VPN_SERVER_PORT:-1194}
    #         - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${VPN_DB_NAME:-iotistic_vpn}
    #         - REDIS_URL=redis://redis:6379
    #         - API_PORT=${VPN_API_PORT:-3200}
    #         - LOG_LEVEL=${VPN_LOG_LEVEL:-info}
    #         - NODE_ENV=${NODE_ENV:-development}
    #     depends_on:
    #         postgres:
    #             condition: service_healthy
    #         redis:
    #             condition: service_healthy
    #     networks:
    #         - iotistic-net
    #     healthcheck:
    #         test: ["CMD", "curl", "-f", "http://localhost:3200/health"]
    #         interval: 30s
    #         timeout: 10s
    #         retries: 3
    #         start_period: 60s
    
    # Protocol Simulators for Testing
    modbus-simulator:
        build:
            context: ./sensors/modbus-simulator
            dockerfile: Dockerfile
        container_name: iotistic-modbus-sim
        restart: unless-stopped
        ports:
            - "502:502"
        networks:
            - iotistic-net
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"
    
    canbus-simulator:
        build:
            context: ./sensors/canbus-simulator
            dockerfile: Dockerfile
        container_name: iotistic-canbus-sim
        restart: unless-stopped
        ports:
            - "11898:11898"
        networks:
            - iotistic-net
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"
    
    opcua-simulator:
        build:
            context: ./sensors/opcua-simulator
            dockerfile: Dockerfile
        container_name: iotistic-opcua-sim
        restart: unless-stopped
        ports:
            - "4840:4840"
        networks:
            - iotistic-net
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"

    neo4j:
        image: neo4j:5.15-community
        container_name: neo4j
        restart: always
        environment:
            - NEO4J_AUTH=neo4j/iotistic123
            - NEO4J_PLUGINS=["apoc"]
            - NEO4J_dbms_security_procedures_unrestricted=apoc.*
            - NEO4J_dbms_memory_heap_initial__size=512m
            - NEO4J_dbms_memory_heap_max__size=2G
        ports:
            - "7474:7474"  # HTTP
            - "7687:7687"  # Bolt
        volumes:
            - neo4j-data:/data
            - neo4j-logs:/logs
            - neo4j-import:/var/lib/neo4j/import
            - neo4j-plugins:/plugins
        networks:
            - iotistic-net
        healthcheck:
            test: ["CMD-SHELL", "cypher-shell -u neo4j -p iotistic123 'RETURN 1'"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"

    housekeeper:
        build:
            context: ./housekeeper
            dockerfile: Dockerfile
        container_name: iotistic-housekeeper
        restart: unless-stopped
        ports:
            - "${HOUSEKEEPER_PORT_EXT:-3400}:3400"
        environment:
            - NODE_ENV=${NODE_ENV:-development}
            - PORT=3400
            - DB_HOST=${DB_HOST:-postgres}
            - DB_PORT=${DB_PORT:-5432}
            - DB_NAME=${DB_NAME:-iotistic}
            - DB_USER=${DB_USER:-postgres}
            - DB_PASSWORD=${DB_PASSWORD:-postgres}
            - LOG_LEVEL=${HOUSEKEEPER_LOG_LEVEL:-info}
            - CLEANUP_INTERVAL=${CLEANUP_INTERVAL:-3600000}
            - RETENTION_DAYS=${RETENTION_DAYS:-30}
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - iotistic-net
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:3400/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    postoffice:
        build:
            context: ./postoffice
            dockerfile: Dockerfile
        container_name: iotistic-postoffice
        restart: unless-stopped
        ports:
            - "${POSTOFFICE_PORT_EXT:-3300}:3300"
        environment:
            - NODE_ENV=${NODE_ENV:-development}
            - PORT=3300
            - HOST=0.0.0.0
            - EMAIL_ENABLED=${EMAIL_ENABLED:-true}
            - EMAIL_FROM=${EMAIL_FROM:-"Iotistic Platform <noreply@iotistic.cloud>"}
            - EMAIL_DEBUG=${EMAIL_DEBUG:-false}
            - BASE_URL=${BASE_URL:-https://iotistic.ca}
            - SMTP_HOST=${SMTP_HOST}
            - SMTP_PORT=${SMTP_PORT:-587}
            - SMTP_SECURE=${SMTP_SECURE:-false}
            - SMTP_USER=${SMTP_USER}
            - SMTP_PASS=${SMTP_PASS}
            - REDIS_HOST=${REDIS_HOST:-redis}
            - REDIS_PORT=${REDIS_PORT:-6379}
            - REDIS_PASSWORD=${REDIS_PASSWORD}
            - DB_HOST=${DB_HOST:-postgres}
            - DB_PORT=${DB_PORT:-5432}
            - DB_NAME=${DB_NAME:-iotistic}
            - DB_USER=${DB_USER:-postgres}
            - DB_PASSWORD=${DB_PASSWORD:-postgres}
            - LOG_LEVEL=${POSTOFFICE_LOG_LEVEL:-info}
        depends_on:
            redis:
                condition: service_healthy
            postgres:
                condition: service_healthy
        networks:
            - iotistic-net
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:3300/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
    wg-server:
        build: ./wg-server
        container_name: wg-server
        restart: unless-stopped
        privileged: true
        # network_mode: host  # Commented out - doesn't work on Windows Docker Desktop
        cap_add:
        - NET_ADMIN
        - SYS_MODULE
        devices:
        - /dev/net/tun:/dev/net/tun
        ports:
        - "8089:8089"           # API port
        - "51820:51820/udp"     # WireGuard VPN port
        volumes:
        - ./wg-server/wg0.conf:/etc/wireguard/wg0.conf
        - wg-data:/var/lib/wireguard
        environment:
        - PORT=8089
        - WG_INTERFACE=wg0
        - SERVER_ENDPOINT=${SERVER_ENDPOINT:-vpn.example.com}
        - DB_HOST=postgres      # Changed back to postgres service name
        - DB_PORT=5432
        - DB_NAME=iotistic
        - DB_USER=postgres
        - DB_PASSWORD=postgres
        - LOG_LEVEL=${LOG_LEVEL:-info}
        networks:
        - iotistic-net
        depends_on:
        - postgres

volumes:
  wg-data:
  
  agent-2-data:
    driver: local
  agent-1-data:
    driver: local
  agent-3-data:
    driver: local
  agent-4-data:
    driver: local
  agent-5-data:
    driver: local
  agent-6-data:
    driver: local
  iotistic-pg-data:
    driver: local
  iotistic-redis-data:
    driver: local
  vpn-config:
    driver: local
  vpn-logs:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  neo4j-import:
    driver: local
  neo4j-plugins:
    driver: local
 
networks:
  iotistic-net:
    driver: bridge
