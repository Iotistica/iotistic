name: Deploy to Kubernetes

on:
  push:
    branches:
      - master
    paths:
      - 'charts/**'
      - 'billing/**'
      - 'api/**'
      - 'dashboard/**'
      - '.github/workflows/deploy-k8s.yml'
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      namespace:
        description: 'Kubernetes namespace (optional)'
        required: false

jobs:
  deploy-billing:
    name: Deploy Billing Service
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-billing]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          kubectl config use-context ${{ secrets.K8S_CONTEXT }}

      - name: Create billing namespace
        run: |
          kubectl create namespace billing --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy billing service
        run: |
          helm upgrade --install billing ./charts/billing \
            --namespace billing \
            --set image.tag=${{ github.sha }} \
            --set postgresql.host=${{ secrets.BILLING_DB_HOST }} \
            --set postgresql.password=${{ secrets.BILLING_DB_PASSWORD }} \
            --set stripe.secretKey=${{ secrets.STRIPE_SECRET_KEY }} \
            --set stripe.webhookSecret=${{ secrets.STRIPE_WEBHOOK_SECRET }} \
            --wait \
            --timeout 10m

      - name: Verify billing deployment
        run: |
          kubectl rollout status deployment/billing-api -n billing --timeout=5m
          kubectl get pods -n billing

  deploy-vpn-server:
    name: Deploy VPN Server
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-vpn]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Create vpn-server namespace
        run: |
          kubectl create namespace vpn-server --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy VPN server
        run: |
          helm upgrade --install vpn-server ./charts/vpn-server \
            --namespace vpn-server \
            --set image.tag=${{ github.sha }} \
            --wait \
            --timeout 10m

      - name: Verify VPN deployment
        run: |
          kubectl rollout status deployment/vpn-server -n vpn-server --timeout=5m
          kubectl get svc -n vpn-server

  deploy-customer-instance:
    name: Deploy Customer Instance
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Set environment variables
        run: |
          ENV="${{ github.event.inputs.environment || 'staging' }}"
          NAMESPACE="${{ github.event.inputs.namespace || 'customer-demo' }}"
          echo "DEPLOY_ENV=$ENV" >> $GITHUB_ENV
          echo "DEPLOY_NAMESPACE=$NAMESPACE" >> $GITHUB_ENV

      - name: Create customer namespace
        run: |
          kubectl create namespace ${{ env.DEPLOY_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace ${{ env.DEPLOY_NAMESPACE }} managed-by=iotistic --overwrite

      - name: Deploy customer instance
        run: |
          helm upgrade --install ${{ env.DEPLOY_NAMESPACE }} ./charts/customer-instance \
            --namespace ${{ env.DEPLOY_NAMESPACE }} \
            --set customerId=${{ env.DEPLOY_NAMESPACE }} \
            --set api.image.tag=${{ github.sha }} \
            --set dashboard.image.tag=${{ github.sha }} \
            --set postgresql.password=${{ secrets.CUSTOMER_DB_PASSWORD }} \
            --set neo4j.password=${{ secrets.NEO4J_PASSWORD }} \
            --set mqtt.adminPassword=${{ secrets.MQTT_ADMIN_PASSWORD }} \
            --set license.key="${{ secrets.IOTISTIC_LICENSE_KEY }}" \
            --wait \
            --timeout 15m

      - name: Verify customer deployment
        run: |
          echo "Checking deployment status..."
          kubectl get pods -n ${{ env.DEPLOY_NAMESPACE }}
          
          echo "Checking API status..."
          kubectl rollout status deployment/${{ env.DEPLOY_NAMESPACE }}-api -n ${{ env.DEPLOY_NAMESPACE }} --timeout=5m
          
          echo "Checking Dashboard status..."
          kubectl rollout status deployment/${{ env.DEPLOY_NAMESPACE }}-dashboard -n ${{ env.DEPLOY_NAMESPACE }} --timeout=5m

      - name: Get service endpoints
        run: |
          echo "## Customer Instance Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Namespace: ${{ env.DEPLOY_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n ${{ env.DEPLOY_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy-monitoring:
    name: Deploy Monitoring Stack
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-monitoring]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Create monitoring namespace
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

      - name: Install Prometheus Operator CRDs
        run: |
          kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
          kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml

      - name: Deploy monitoring stack
        run: |
          kubectl apply -f ./charts/monitoring-stack.yaml

      - name: Verify monitoring deployment
        run: |
          kubectl get pods -n monitoring
          kubectl get servicemonitors --all-namespaces

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-24.04
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy-billing, deploy-vpn-server, deploy-customer-instance]
    
    steps:
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Rollback deployments
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'customer-demo' }}"
          
          echo "Rolling back deployments in namespace: $NAMESPACE"
          
          helm rollback $NAMESPACE -n $NAMESPACE || echo "No previous release to rollback"
          
          echo "Rollback initiated. Check status:"
          kubectl get pods -n $NAMESPACE

  report:
    name: Deployment Report
    needs: [deploy-billing, deploy-vpn-server, deploy-customer-instance, deploy-monitoring]
    runs-on: ubuntu-24.04
    if: always()
    
    steps:
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl context
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Generate deployment report
        run: |
          echo "## Kubernetes Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cluster Information" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl cluster-info >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Namespace Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get namespaces -l managed-by=iotistic >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Pod Status (All Namespaces)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods --all-namespaces -l app.kubernetes.io/managed-by=Helm >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc --all-namespaces -l managed-by=iotistic >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
