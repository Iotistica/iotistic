name: CI Build and Push Dashboard Image

on: 
  push:
    branches:
      - master
    paths:
      - 'dashboard/**' 
      - '.github/workflows/build-dashboard-ci.yml'

jobs:
  test:
    name: Run Tests
    runs-on: [self-hosted, iotistic-lab-sc]
    defaults:
      run:
        working-directory: ./dashboard
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build dashboard
        run: npm run build

      - name: Start preview server
        run: |
          npm install -g serve
          serve -s build -l 3000 &
          echo $! > .serve.pid
          
          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 1; done'

      - name: Run Playwright Smoke Tests
        run: npm run test:e2e:smoke
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Generate test summary
        if: always()
        run: |
          echo "## Dashboard Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests verify that the dashboard builds and loads correctly." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Homepage loads successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Root element exists" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No critical console errors" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Responsive load time" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Valid HTML structure" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ CSS styles loaded" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ JavaScript executed" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: dashboard/playwright-report/
          retention-days: 7

      - name: Stop preview server
        if: always()
        run: |
          if [ -f .serve.pid ]; then
            kill $(cat .serve.pid) || true
            rm .serve.pid
          fi

  version:
    name: Bump Version
    needs: test
    runs-on: [self-hosted, iotistic-lab-sc]
    outputs:
      new_version: ${{ steps.version_bump.outputs.new_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: version_bump
        working-directory: ./dashboard
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          npm version $NEW_VERSION --no-git-tag-version
          
          git add package.json package-lock.json
          git commit -m "chore(dashboard): bump version to $NEW_VERSION [skip ci]" || echo "No changes to commit"
          git push origin master || echo "Nothing to push"

  buildx:
    name: Build & Push Dashboard Image
    needs: version
    runs-on: [self-hosted, iotistic-lab-sc]
    strategy:
      matrix:
        include:
          - board: x86
            platform: linux/amd64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Pull latest changes
        run: git pull origin master

      - name: Get version
        id: get_version
        working-directory: ./dashboard
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Dashboard version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1
            network=host

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache/${{ matrix.board }}
          key: ${{ runner.os }}-buildx-dashboard-${{ matrix.board }}-${{ hashFiles('dashboard/package-lock.json', 'dashboard/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-dashboard-${{ matrix.board }}-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build & Push Dashboard image
        uses: docker/build-push-action@v5
        with:
          context: ./dashboard
          file: ./dashboard/Dockerfile
          push: true
          platforms: ${{ matrix.platform }}
          cache-from: |
            type=local,src=/tmp/.buildx-cache/${{ matrix.board }}
            type=registry,ref=iotistic/dashboard:buildcache
          cache-to: type=local,dest=/tmp/.buildx-cache-new/${{ matrix.board }},mode=max
          tags: |
            iotistic/dashboard:latest
            iotistic/dashboard:${{ github.sha }}
            iotistic/dashboard:${{ steps.get_version.outputs.version }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Move cache to prevent unlimited growth
      - name: Move cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache/${{ matrix.board }}
          mv /tmp/.buildx-cache-new/${{ matrix.board }} /tmp/.buildx-cache/${{ matrix.board }} || true

  report:
    name: Generate Build Report
    needs: buildx
    runs-on: [self-hosted, iotistic-lab-sc]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Docker image
        run: docker pull iotistic/dashboard:latest || true

      - name: Generate changelog
        id: changelog
        run: |
          echo "## Dashboard Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log --oneline --no-merges -10 -- dashboard/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Image size report
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Image Size" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker images iotistic/dashboard:latest --format "{{.Repository}}:{{.Tag}} - {{.Size}}" >> $GITHUB_STEP_SUMMARY || echo "Image not available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  trigger-integration-tests:
    name: Trigger Integration Tests
    needs: [version, buildx]
    runs-on: [self-hosted, iotistic-lab-sc]
    permissions:
      actions: write
      contents: read
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Trigger integration tests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'integration-tests.yml',
              ref: 'master',
              inputs: {
                dashboard_version: '${{ needs.version.outputs.new_version }}'
              }
            });
            
            console.log('Integration tests triggered with Dashboard version: ${{ needs.version.outputs.new_version }}');
