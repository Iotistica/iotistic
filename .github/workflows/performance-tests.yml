name: Performance Tests

env:
  COMPOSE_FILE: docker-compose.e2e.yml

# Run performance tests on-demand or scheduled
on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration (e.g., 30s, 5m, 1h)'
        required: false
        default: '30s'
      vus:
        description: 'Number of virtual users'
        required: false
        default: '50'
  schedule:
    # Run performance tests weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  pull_request:
    branches:
      - master
    paths:
      - 'api/**'
      - 'agent/**'
    # Only run on PR if labeled with 'performance'
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Only run if labeled with 'performance' on PR, or always on schedule/manual
  check-conditions:
    name: Check Run Conditions
    runs-on: ubuntu-24.04
    outputs:
      should-run: ${{ steps.check.outputs.run }}
    steps:
      - name: Check if should run
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'performance') }}" == "true" ]]; then
              echo "run=true" >> $GITHUB_OUTPUT
            else
              echo "run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "run=true" >> $GITHUB_OUTPUT
          fi

  setup-infrastructure:
    name: Setup Test Infrastructure
    needs: check-conditions
    if: needs.check-conditions.outputs.should-run == 'true'
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          chmod +x .github/scripts/setup-env.sh
          LICENSE_PUBLIC_KEY="${{ secrets.LICENSE_PUBLIC_KEY }}" \
          IOTISTIC_LICENSE_KEY="${{ secrets.IOTISTIC_LICENSE_KEY }}" \
          .github/scripts/setup-env.sh

      - name: Start full stack
        run: docker compose -f $COMPOSE_FILE up -d

      - name: Wait for services
        run: |
          echo "Waiting for all services to be ready..."
          timeout 180 bash -c '
            until curl -f http://localhost:4002/health > /dev/null 2>&1; do
              sleep 3
            done
          '
          echo "Services are ready!"

      - name: Display service status
        run: docker compose -f $COMPOSE_FILE ps

  api-load-test:
    name: API Load Testing (k6)
    needs: setup-infrastructure
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          chmod +x .github/scripts/setup-env.sh
          LICENSE_PUBLIC_KEY="${{ secrets.LICENSE_PUBLIC_KEY }}" \
          IOTISTIC_LICENSE_KEY="${{ secrets.IOTISTIC_LICENSE_KEY }}" \
          .github/scripts/setup-env.sh

      - name: Start services
        run: docker compose -f $COMPOSE_FILE up -d

      - name: Wait for API
        run: |
          timeout 180 bash -c '
            until curl -f http://localhost:4002/health > /dev/null 2>&1; do
              sleep 3
            done
          '

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create k6 test script
        run: |
          mkdir -p .github/k6
          cat > .github/k6/api-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate } from 'k6/metrics';

          const errorRate = new Rate('errors');

          export const options = {
            stages: [
              { duration: '30s', target: 20 },  // Ramp up to 20 users
              { duration: '1m', target: 50 },   // Stay at 50 users
              { duration: '30s', target: 0 },   // Ramp down to 0 users
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],  // 95% of requests should be below 500ms
              http_req_failed: ['rate<0.01'],    // Error rate should be less than 1%
            },
          };

          const BASE_URL = 'http://localhost:4002';

          export default function () {
            // Test health endpoint
            let healthRes = http.get(`${BASE_URL}/health`);
            check(healthRes, {
              'health status is 200': (r) => r.status === 200,
            }) || errorRate.add(1);

            sleep(1);

            // Test devices endpoint
            let devicesRes = http.get(`${BASE_URL}/api/devices`);
            check(devicesRes, {
              'devices status is 200 or 401': (r) => r.status === 200 || r.status === 401,
            }) || errorRate.add(1);

            sleep(1);
          }
          EOF

      - name: Run k6 load test
        run: |
          k6 run --out json=results.json .github/k6/api-test.js

      - name: Upload k6 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: results.json

      - name: Cleanup
        if: always()
        run: docker compose -f $COMPOSE_FILE down -v

  mqtt-performance-test:
    name: MQTT Broker Performance
    needs: setup-infrastructure
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          chmod +x .github/scripts/setup-env.sh
          LICENSE_PUBLIC_KEY="${{ secrets.LICENSE_PUBLIC_KEY }}" \
          IOTISTIC_LICENSE_KEY="${{ secrets.IOTISTIC_LICENSE_KEY }}" \
          .github/scripts/setup-env.sh

      - name: Start services
        run: docker compose -f $COMPOSE_FILE up -d postgres mosquitto

      - name: Wait for Mosquitto
        run: sleep 20

      - name: Install MQTT benchmark tool
        run: |
          sudo apt-get update
          sudo apt-get install -y mosquitto-clients

      - name: Run MQTT pub/sub test
        run: |
          echo "Testing MQTT publish performance..."
          
          # Publish 1000 messages
          for i in {1..1000}; do
            mosquitto_pub -h localhost -p 5883 -t "test/perf" -m "Message $i" -q 1
          done
          
          echo "MQTT performance test completed"

      - name: Cleanup
        if: always()
        run: docker compose -f $COMPOSE_FILE down -v

  database-benchmark:
    name: PostgreSQL Performance
    needs: setup-infrastructure
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          chmod +x .github/scripts/setup-env.sh
          LICENSE_PUBLIC_KEY="${{ secrets.LICENSE_PUBLIC_KEY }}" \
          IOTISTIC_LICENSE_KEY="${{ secrets.IOTISTIC_LICENSE_KEY }}" \
          .github/scripts/setup-env.sh

      - name: Start PostgreSQL
        run: docker compose -f $COMPOSE_FILE up -d postgres

      - name: Wait for PostgreSQL
        run: |
          timeout 60 bash -c '
            until docker compose -f $COMPOSE_FILE exec -T postgres pg_isready -U postgres; do
              sleep 2
            done
          '

      - name: Run pgbench
        run: |
          echo "Initializing pgbench..."
          docker compose -f $COMPOSE_FILE exec -T postgres pgbench -i -s 10 -U postgres iotistic
          
          echo "Running benchmark (10 clients, 100 transactions each)..."
          docker compose -f $COMPOSE_FILE exec -T postgres pgbench -c 10 -t 100 -U postgres iotistic

      - name: Cleanup
        if: always()
        run: docker compose -f $COMPOSE_FILE down -v

  redis-benchmark:
    name: Redis Performance
    needs: setup-infrastructure
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          chmod +x .github/scripts/setup-env.sh
          LICENSE_PUBLIC_KEY="${{ secrets.LICENSE_PUBLIC_KEY }}" \
          IOTISTIC_LICENSE_KEY="${{ secrets.IOTISTIC_LICENSE_KEY }}" \
          .github/scripts/setup-env.sh

      - name: Start Redis
        run: docker compose -f $COMPOSE_FILE up -d redis

      - name: Wait for Redis
        run: sleep 10

      - name: Run redis-benchmark
        run: |
          echo "Running Redis benchmark..."
          docker compose -f $COMPOSE_FILE exec -T redis redis-benchmark -q -n 10000

      - name: Cleanup
        if: always()
        run: docker compose -f $COMPOSE_FILE down -v

  performance-report:
    name: Generate Performance Report
    needs: [api-load-test, mqtt-performance-test, database-benchmark, redis-benchmark]
    runs-on: ubuntu-24.04
    if: always()
    
    steps:
      - name: Download k6 results
        uses: actions/download-artifact@v4
        with:
          name: k6-results
        continue-on-error: true

      - name: Generate performance summary
        run: |
          echo "## Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ github.event.inputs.duration || '30s' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Virtual Users**: ${{ github.event.inputs.vus || '50' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- API Load Test: ${{ needs.api-load-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- MQTT Performance: ${{ needs.mqtt-performance-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Database Benchmark: ${{ needs.database-benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Redis Benchmark: ${{ needs.redis-benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results.json ]; then
            echo "### k6 Results Summary" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat results.json | tail -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
