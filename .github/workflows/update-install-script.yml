name: Upload Installation Scripts to Azure

on:
  # Manual trigger only
  workflow_dispatch:

jobs:
  upload-install-scripts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get agent version
        id: version
        run: |
          VERSION=$(jq -r .version agent/package.json)
          echo "package_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Agent version: $VERSION"

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Enable blob versioning (if not already enabled)
        run: |
          # Check if versioning is already enabled
          VERSIONING_ENABLED=$(az storage account blob-service-properties show \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --query 'isVersioningEnabled' -o tsv 2>/dev/null || echo "false")
          
          if [ "$VERSIONING_ENABLED" != "true" ]; then
            echo "Enabling blob versioning on storage account..."
            az storage account blob-service-properties update \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --enable-versioning true
            echo "✓ Blob versioning enabled"
          else
            echo "✓ Blob versioning already enabled"
          fi

      - name: Prepare versioned scripts
        run: |
          # Create temporary directory for versioned scripts
          mkdir -p /tmp/iotistic-scripts
          
          # Replace version placeholder in install-docker.sh
          sed "s/AGENT_VERSION_PLACEHOLDER/${{ steps.version.outputs.package_version }}/g" \
            agent/bin/install-docker.sh > /tmp/iotistic-scripts/install-docker.sh
          
          # Replace version placeholder in install-systemd.sh
          sed "s/AGENT_VERSION_PLACEHOLDER/${{ steps.version.outputs.package_version }}/g" \
            agent/bin/install-systemd.sh > /tmp/iotistic-scripts/install-systemd.sh
          
          echo "✓ Prepared scripts with version ${{ steps.version.outputs.package_version }}"

      - name: Generate checksums
        run: |
          cd /tmp/iotistic-scripts
          sha256sum install-docker.sh > install-docker.sh.sha256
          sha256sum install-systemd.sh > install-systemd.sh.sha256
          
          echo "✓ Generated SHA256 checksums:"
          cat install-docker.sh.sha256
          cat install-systemd.sh.sha256

      - name: Upload install-docker.sh (latest)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/install-docker.sh \
            --file /tmp/iotistic-scripts/install-docker.sh \
            --overwrite true \
            --content-type application/x-sh \
            --content-disposition "attachment; filename=install-docker.sh"
          
          echo "✓ Uploaded agent/install-docker.sh (latest)"

      - name: Upload install-docker.sh checksum (latest)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/install-docker.sh.sha256 \
            --file /tmp/iotistic-scripts/install-docker.sh.sha256 \
            --overwrite true \
            --content-type text/plain \
            --content-disposition "inline; filename=install-docker.sh.sha256"
          
          echo "✓ Uploaded agent/install-docker.sh.sha256"

      - name: Upload install-docker.sh (versioned)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/versions/install-docker-${{ steps.version.outputs.package_version }}.sh \
            --file /tmp/iotistic-scripts/install-docker.sh \
            --overwrite true \
            --content-type application/x-sh \
            --content-disposition "attachment; filename=install-docker-${{ steps.version.outputs.package_version }}.sh"
          
          echo "✓ Uploaded agent/versions/install-docker-${{ steps.version.outputs.package_version }}.sh"

      - name: Upload install-docker.sh checksum (versioned)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/versions/install-docker-${{ steps.version.outputs.package_version }}.sh.sha256 \
            --file /tmp/iotistic-scripts/install-docker.sh.sha256 \
            --overwrite true \
            --content-type text/plain \
            --content-disposition "inline; filename=install-docker-${{ steps.version.outputs.package_version }}.sh.sha256"
          
          echo "✓ Uploaded agent/versions/install-docker-${{ steps.version.outputs.package_version }}.sh.sha256"

      - name: Upload install-systemd.sh (latest)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/install-systemd.sh \
            --file /tmp/iotistic-scripts/install-systemd.sh \
            --overwrite true \
            --content-type application/x-sh \
            --content-disposition "attachment; filename=install-systemd.sh"
          
          echo "✓ Uploaded agent/install-systemd.sh (latest)"

      - name: Upload install-systemd.sh checksum (latest)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/install-systemd.sh.sha256 \
            --file /tmp/iotistic-scripts/install-systemd.sh.sha256 \
            --overwrite true \
            --content-type text/plain \
            --content-disposition "inline; filename=install-systemd.sh.sha256"
          
          echo "✓ Uploaded agent/install-systemd.sh.sha256"

      - name: Upload install-systemd.sh (versioned)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/versions/install-systemd-${{ steps.version.outputs.package_version }}.sh \
            --file /tmp/iotistic-scripts/install-systemd.sh \
            --overwrite true \
            --content-type application/x-sh \
            --content-disposition "attachment; filename=install-systemd-${{ steps.version.outputs.package_version }}.sh"
          
          echo "✓ Uploaded agent/versions/install-systemd-${{ steps.version.outputs.package_version }}.sh"

      - name: Upload install-systemd.sh checksum (versioned)
        run: |
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --name agent/versions/install-systemd-${{ steps.version.outputs.package_version }}.sh.sha256 \
            --file /tmp/iotistic-scripts/install-systemd.sh.sha256 \
            --overwrite true \
            --content-type text/plain \
            --content-disposition "inline; filename=install-systemd-${{ steps.version.outputs.package_version }}.sh.sha256"
          
          echo "✓ Uploaded agent/versions/install-systemd-${{ steps.version.outputs.package_version }}.sh.sha256"

      - name: Upload legacy install.sh (if exists)
        run: |
          if [ -f bin/install.sh ]; then
            az storage blob upload \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --container-name scripts \
              --name install.sh \
              --file bin/install.sh \
              --overwrite true \
              --content-type application/octet-stream \
              --content-disposition "attachment; filename=install.sh"
            
            echo "✓ Uploaded install.sh"
          else
            echo "⚠ install.sh not found, skipping"
          fi

      - name: Generate summary
        run: |
          echo "# Installation Scripts Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Latest Scripts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -sSL https://apps.iotistic.com/agent/install-docker.sh | sudo bash" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Systemd Installation (with PM2)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -sSL https://apps.iotistic.com/agent/install-systemd.sh | sudo bash" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Version ${{ steps.version.outputs.package_version }} Scripts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Installation (Versioned)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -sSL https://apps.iotistic.com/agent/versions/install-docker-${{ steps.version.outputs.package_version }}.sh | sudo bash" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Systemd Installation (Versioned)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -sSL https://apps.iotistic.com/agent/versions/install-systemd-${{ steps.version.outputs.package_version }}.sh | sudo bash" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**install-docker.sh:**" >> $GITHUB_STEP_SUMMARY
          echo "- Installs Docker if needed" >> $GITHUB_STEP_SUMMARY
          echo "- Pulls latest agent image from Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "- Runs agent as Docker container with auto-restart" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive configuration (provisioning key, port)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**install-systemd.sh:**" >> $GITHUB_STEP_SUMMARY
          echo "- Installs all system dependencies (SQLite, Docker, OpenVPN, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "- Installs Node.js 20 and PM2 process manager" >> $GITHUB_STEP_SUMMARY
          echo "- Downloads and builds latest agent release" >> $GITHUB_STEP_SUMMARY
          echo "- Creates systemd service with PM2" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive configuration (provisioning key, port)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ All installation scripts uploaded successfully!" >> $GITHUB_STEP_SUMMARY
