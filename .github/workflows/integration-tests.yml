name: E2E Integration Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  COMPOSE_FILE: docker-compose.e2e.yml

jobs:
  e2e-tests:
    name: Run E2E Integration Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          # PostgreSQL
          POSTGRES_DB=iotistic
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          
          # Redis
          REDIS_PORT_EXT=6379
          REDIS_HOST=redis
          REDIS_PORT=6379
          
          # API
          API_PORT_EXT=4002
          PORT=3002
          NODE_ENV=development
          
          # Database Connection
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=iotistic
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_POOL_SIZE=20
          
          # MQTT
          MOSQUITTO_PORT_EXT=5883
          MOSQUITTO_WS_PORT_EXT=59002
          MQTT_BROKER_URL=mqtt://mosquitto:1883
          MQTT_USERNAME=admin
          MQTT_PASSWORD=iotistic42!
          MQTT_PERSIST_TO_DB=true
          MQTT_DB_SYNC_INTERVAL=10000
          MQTT_MONITOR_ENABLED=true
          
          # Neo4j
          NEO4J_URI=bolt://neo4j:7687
          NEO4J_USERNAME=neo4j
          NEO4J_PASSWORD=iotistic123
          
          # Dashboard
          DASHBOARD_PORT_EXT=3000
          
          # VPN
          VPN_SERVER_PORT=1194
          VPN_API_PORT=3200
          VPN_MGMT_PORT=7505
          VPN_CA_PORT=8080
          VPN_SERVER_HOST=localhost
          VPN_DB_NAME=iotistic_vpn
          
          # License Keys
          LICENSE_PUBLIC_KEY=${{ secrets.LICENSE_PUBLIC_KEY }}
          IOTISTIC_LICENSE_KEY=${{ secrets.IOTISTIC_LICENSE_KEY }}
          
          # Logging
          FORCE_COLOR=1
          LOG_COMPRESSION=true
          EOF

      - name: Build and start all services
        run: |
          echo "Starting E2E test stack..."
          docker compose -f docker-compose.e2e.yml up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for all services to be healthy..."
          timeout 180 bash -c '
            while true; do
              # Check postgres
              if ! docker compose -f docker-compose.e2e.yml exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
                echo "Waiting for PostgreSQL..."
                sleep 3
                continue
              fi
              
              # Check redis
              if ! docker compose -f docker-compose.e2e.yml exec -T redis redis-cli ping > /dev/null 2>&1; then
                echo "Waiting for Redis..."
                sleep 3
                continue
              fi
              
              # Check neo4j
              if ! docker compose -f docker-compose.e2e.yml exec -T neo4j cypher-shell -u neo4j -p iotistic123 "RETURN 1" > /dev/null 2>&1; then
                echo "Waiting for Neo4j..."
                sleep 3
                continue
              fi
              
              # Check API health endpoint
              if ! curl -f http://localhost:4002/health > /dev/null 2>&1; then
                echo "Waiting for API..."
                sleep 3
                continue
              fi
              
              # Check Dashboard
              if ! curl -f http://localhost:3000 > /dev/null 2>&1; then
                echo "Waiting for Dashboard..."
                sleep 3
                continue
              fi
              
              echo "All services are healthy!"
              break
            done
          '

      - name: Verify service status
        run: |
          echo "=== Service Status ==="
          docker compose -f docker-compose.e2e.yml ps

      - name: Test PostgreSQL
        run: |
          echo "Testing PostgreSQL..."
          docker compose -f docker-compose.e2e.yml exec -T postgres psql -U postgres -c "SELECT version();"
          docker compose -f docker-compose.e2e.yml exec -T postgres psql -U postgres -lqt | grep -q iotistic
          echo "PostgreSQL test passed!"

      - name: Test Redis
        run: |
          echo "Testing Redis..."
          docker compose -f docker-compose.e2e.yml exec -T redis redis-cli ping
          docker compose -f docker-compose.e2e.yml exec -T redis redis-cli SET test_key "test_value"
          docker compose -f docker-compose.e2e.yml exec -T redis redis-cli GET test_key
          echo "Redis test passed!"

      - name: Test Neo4j
        run: |
          echo "Testing Neo4j..."
          docker compose -f docker-compose.e2e.yml exec -T neo4j cypher-shell -u neo4j -p iotistic123 "RETURN 'Neo4j is working!' AS message"
          echo "Neo4j test passed!"

      - name: Test MQTT Broker
        run: |
          echo "Testing Mosquitto MQTT..."
          docker compose -f docker-compose.e2e.yml exec -T mosquitto sh -c "nc -zv localhost 1883"
          echo "MQTT broker test passed!"

      - name: Test API endpoints
        run: |
          echo "Testing API health endpoint..."
          curl -f http://localhost:4002/health
          
          echo "Testing API devices endpoint..."
          curl -f http://localhost:4002/api/devices || echo "Devices endpoint returned expected response"
          
          echo "API tests passed!"

      - name: Test Dashboard
        run: |
          echo "Testing Dashboard..."
          curl -f http://localhost:3000
          echo "Dashboard test passed!"

      - name: Check agent connectivity
        run: |
          echo "Checking agent logs..."
          docker compose -f docker-compose.e2e.yml logs agent-12 --tail=50
          docker compose -f docker-compose.e2e.yml logs agent-13 --tail=50

      - name: Display service logs on failure
        if: failure()
        run: |
          echo "=== PostgreSQL Logs ==="
          docker compose -f docker-compose.e2e.yml logs postgres --tail=100
          
          echo "=== Redis Logs ==="
          docker compose -f docker-compose.e2e.yml logs redis --tail=100
          
          echo "=== Neo4j Logs ==="
          docker compose -f docker-compose.e2e.yml logs neo4j --tail=100
          
          echo "=== Mosquitto Logs ==="
          docker compose -f docker-compose.e2e.yml logs mosquitto --tail=100
          
          echo "=== API Logs ==="
          docker compose -f docker-compose.e2e.yml logs api --tail=100
          
          echo "=== Dashboard Logs ==="
          docker compose -f docker-compose.e2e.yml logs dashboard --tail=100
          
          echo "=== Agent-12 Logs ==="
          docker compose -f docker-compose.e2e.yml logs agent-12 --tail=100
          
          echo "=== Agent-13 Logs ==="
          docker compose -f docker-compose.e2e.yml logs agent-13 --tail=100

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping and removing all containers..."
          docker compose -f docker-compose.e2e.yml down -v
          echo "Cleanup complete!"
