name: CI Build, Test & Push Device Agent

on: 
  push:
    branches:
      - master
    paths:
      - 'agent/**' 
      - '.github/workflows/build-device-agent-ci.yml'

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: agent/package-lock.json

      - name: Install Agent dependencies
        working-directory: ./agent
        run: npm ci

      - name: Run unit tests
        working-directory: ./agent
        run: npm run test:unit

      - name: Build Agent
        working-directory: ./agent
        run: npm run build

  test-systemd:
    name: Validate Systemd Installation
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install systemd tools
        run: |
          sudo apt-get update
          sudo apt-get install -y systemd shellcheck

      - name: Validate systemd service file syntax
        run: |
          echo "Validating iotistic-agent.service syntax..."
          systemd-analyze verify agent/scripts/iotistic-agent.service || true
          
          # Check for common issues
          echo "Checking service file for common issues..."
          grep -q "Type=simple" agent/scripts/iotistic-agent.service && echo "âœ“ Service type: simple"
          grep -q "Restart=always" agent/scripts/iotistic-agent.service && echo "âœ“ Restart policy: always"
          grep -q "User=iotistic" agent/scripts/iotistic-agent.service && echo "âœ“ Non-root user: iotistic"
          grep -q "After=.*docker.service" agent/scripts/iotistic-agent.service && echo "âœ“ Docker dependency configured"

      - name: Shellcheck installation script
        run: |
          echo "Running shellcheck on install-systemd.sh..."
          shellcheck agent/scripts/install-systemd.sh

      - name: Dry-run installation test
        run: |
          echo "Testing installation script (dry-run mode)..."
          
          # Setup Node.js for the test
          cd agent
          npm ci
          npm run build
          cd ..
          
          # Create mock environment
          sudo mkdir -p /opt/iotistic/test-agent
          sudo mkdir -p /etc/iotistic/test
          sudo mkdir -p /var/lib/iotistic/test-agent
          sudo mkdir -p /var/log/iotistic/test
          
          # Test key parts of installation script
          echo "âœ“ Directory creation works"
          
          # Verify service file can be copied
          sudo cp agent/scripts/iotistic-agent.service /tmp/test-agent.service
          echo "âœ“ Service file is valid and copyable"
          
          # Check if script is executable
          test -x agent/scripts/install-systemd.sh && echo "âœ“ Installation script is executable" || chmod +x agent/scripts/install-systemd.sh
          
          # Validate script structure
          bash -n agent/scripts/install-systemd.sh
          echo "âœ“ Installation script syntax is valid"
          
          # Cleanup
          sudo rm -rf /opt/iotistic/test-agent /etc/iotistic/test /var/lib/iotistic/test-agent /var/log/iotistic/test /tmp/test-agent.service

      - name: Generate validation summary
        if: always()
        run: |
          echo "# Systemd Installation Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Files Validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ \`agent/scripts/iotistic-agent.service\` - Systemd unit file" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ \`agent/scripts/install-systemd.sh\` - Installation script" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "1. Systemd service file syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "2. Service configuration verification" >> $GITHUB_STEP_SUMMARY
          echo "3. Shell script linting (shellcheck)" >> $GITHUB_STEP_SUMMARY
          echo "4. Installation script syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "5. Directory structure dry-run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All systemd installation artifacts validated successfully!" >> $GITHUB_STEP_SUMMARY

  version:
    name: Bump Version
    needs: [test, test-systemd]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    outputs:
      package_version: ${{ steps.bump.outputs.package_version }}
      sha_short: ${{ steps.bump.outputs.sha_short }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version in package.json
        id: bump
        run: |
          cd agent
          # Get current version
          CURRENT_VERSION=$(jq -r '.version' package.json)
          echo "Current version: $CURRENT_VERSION"
          
          # Bump patch version (e.g., 1.0.0 -> 1.0.1)
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "New version: $NEW_VERSION"
          
          # Update package.json
          jq --arg v "$NEW_VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          
          # Set outputs
          echo "package_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Commit and push version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add agent/package.json
          git commit -m "chore: bump agent version to ${{ steps.bump.outputs.package_version }} [skip ci]"
          git push origin HEAD

      - name: Display version info
        run: |
          echo "## Version Bumped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** \`${{ steps.bump.outputs.package_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA:** \`${{ steps.bump.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY

  buildx:
    name: Build & Push to Docker
    needs: version
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Display Version Update
        run: |
          echo "## Building Version ${{ needs.version.outputs.package_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.version.outputs.package_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA:** \`${{ needs.version.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Tags:" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:${{ needs.version.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:${{ needs.version.outputs.package_version }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-agent-v2-${{ github.sha }}
          restore-keys: |
            buildx-agent-v2-

      # Login to Docker Hub (only if tests passed)
      - name: Login to Docker Hub
        if: success()
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # Build and push to registry
      - name: Build & Push final image
        id: docker_build
        if: success()
        uses: docker/build-push-action@v5
        with:
          context: ./agent
          file: ./agent/Dockerfile
          push: true
          platforms: linux/amd64
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache,mode=max
          tags: |
            iotistic/agent:latest
            iotistic/agent:${{ needs.version.outputs.sha_short }}
            iotistic/agent:${{ needs.version.outputs.package_version }}

  test-agent-docker:
    name: Test Published Agent Image
    needs: [version, buildx]
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Pull published agent image
        run: |
          echo "Pulling published image: iotistic/agent:${{ needs.version.outputs.package_version }}"
          docker pull iotistic/agent:${{ needs.version.outputs.package_version }}

      - name: Run agent container standalone
        run: |
          echo "Starting agent container with published image..."
          docker run -d \
            --name agent-test \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -e AGENT_VERSION=${{ needs.version.outputs.package_version }} \
            -e DEVICE_API_PORT=48484 \
            -e NODE_ENV=production \
            -e LOG_LEVEL=info \
            -e ORCHESTRATOR_TYPE=docker-compose \
            -e ORCHESTRATOR_INTERVAL=30000 \
            -e REQUIRE_PROVISIONING=false \
            -e PROVISIONING_API_KEY=test_provisioning_key_for_ci \
            iotistic/agent:${{ needs.version.outputs.package_version }}
          
          echo "Waiting for agent to start..."
          sleep 15

      - name: Check agent container is running
        run: |
          if docker ps | grep -q agent-test; then
            echo "âœ“ Agent container is running"
            docker ps | grep agent-test
          else
            echo "âœ— Agent container failed to start"
            docker logs agent-test
            exit 1
          fi

      - name: Test agent API health
        run: |
          echo "Testing agent API endpoints..."
          
          # Try health endpoint (using wget since it's in alpine)
          if docker exec agent-test wget -q -O- http://localhost:48484/health 2>/dev/null || \
             docker exec agent-test wget -q -O- http://localhost:48484/v2/device 2>/dev/null; then
            echo "âœ“ Agent API is responding"
          else
            echo "âš  Agent API not responding yet (may still be initializing)"
            docker logs --tail=50 agent-test
          fi

      - name: Verify agent logs for startup
        run: |
          echo "Checking agent logs for successful startup..."
          
          # Check for reconciliation started (REQUIRED)
          if docker logs agent-test 2>&1 | grep -q "Auto-reconciliation started"; then
            echo "Auto-reconciliation started"
          else
            echo "Auto-reconciliation did not start - agent failed to initialize properly"
            echo "Full logs:"
            docker logs agent-test
            exit 1
          fi
          
          # Optional checks for additional startup indicators
          docker logs agent-test | grep -i "server" || true
          docker logs agent-test | grep -i "listening" || true

      - name: Show full agent logs
        if: always()
        run: |
          echo "========================================="
          echo "Agent Logs (Full):"
          echo "========================================="
          docker logs agent-test

      - name: Cleanup test environment
        if: always()
        run: |
          docker stop agent-test || true
          docker rm agent-test || true
          docker system prune -f

      - name: Generate test summary
        if: always()
        run: |
          echo "# Agent Docker Image Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Published Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`iotistic/agent:${{ needs.version.outputs.package_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: Standalone container" >> $GITHUB_STEP_SUMMARY
          echo "- **Provisioning**: Local mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests Performed" >> $GITHUB_STEP_SUMMARY
          echo "1. Pull published Docker image from registry" >> $GITHUB_STEP_SUMMARY
          echo "2. Container startup" >> $GITHUB_STEP_SUMMARY
          echo "3. API endpoint health check" >> $GITHUB_STEP_SUMMARY
          echo "4. Log verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Agent image validated successfully!" >> $GITHUB_STEP_SUMMARY

  test-agent-systemd:
    name: Test Agent as Systemd Service
    needs: version
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            make \
            g++ \
            sqlite3 \
            libsqlite3-dev \
            curl \
            jq \
            procps \
            openvpn \
            iproute2 \
            iptables \
            net-tools \
            iputils-ping \
            systemd

      - name: Install Docker
        run: |
          # Install Docker
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          
          # Start Docker service
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Wait for Docker to be ready
          timeout 30 sh -c 'until docker info; do sleep 2; done'
          echo "âœ“ Docker installed and running"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: agent/package-lock.json

      - name: Create iotistic user
        run: |
          sudo useradd --system --home-dir /opt/iotistic --shell /bin/bash iotistic
          sudo usermod -aG docker iotistic
          echo "âœ“ Created iotistic user and added to docker group"

      - name: Install agent to /opt/iotistic/agent
        run: |
          sudo mkdir -p /opt/iotistic/agent
          sudo cp -r agent/* /opt/iotistic/agent/
          
          cd /opt/iotistic/agent
          sudo npm ci --legacy-peer-deps
          sudo npm run build
          
          # Install PM2 globally for process management
          sudo npm install -g pm2
          
          echo "âœ“ Agent installed and built"
          echo "âœ“ PM2 installed"

      - name: Create directories and environment file
        run: |
          sudo mkdir -p /etc/iotistic
          sudo mkdir -p /var/lib/iotistic/agent
          sudo mkdir -p /var/log/iotistic
          
          # Create environment file with same env vars as Docker test
          sudo tee /etc/iotistic/agent.env > /dev/null << EOF
          AGENT_VERSION=${{ needs.version.outputs.package_version }}
          DEVICE_API_PORT=48484
          NODE_ENV=production
          LOG_LEVEL=info
          REQUIRE_PROVISIONING=false
          PROVISIONING_API_KEY=test_provisioning_key_for_ci
          EOF
          
          echo "âœ“ Directories and environment file created"
          echo "âœ“ Agent version: ${{ needs.version.outputs.package_version }}"

      - name: Set permissions
        run: |
          sudo chown -R iotistic:iotistic /opt/iotistic/agent
          sudo chown -R iotistic:iotistic /var/lib/iotistic/agent
          sudo chown -R iotistic:iotistic /var/log/iotistic
          sudo chown iotistic:iotistic /etc/iotistic/agent.env
          sudo chmod 600 /etc/iotistic/agent.env
          
          echo "âœ“ Permissions set"

      - name: Start agent with PM2
        run: |
          cd /opt/iotistic/agent
          
          # Start with PM2 as iotistic user, loading env file
          sudo -u iotistic pm2 start dist/index.js \
            --name iotistic-agent \
            --cwd /opt/iotistic/agent \
            --log /var/log/iotistic/agent.log \
            --time \
            --env-file /etc/iotistic/agent.env
          
          echo "âœ“ Agent started with PM2"
          
          # Wait for agent to initialize
          sleep 20

      - name: Check PM2 status
        run: |
          echo "PM2 Process List:"
          sudo -u iotistic pm2 list
          
          echo ""
          echo "Agent Process Info:"
          sudo -u iotistic pm2 info iotistic-agent
          
          # Check if process is online
          if sudo -u iotistic pm2 list | grep -q "online"; then
            echo "âœ“ Agent is running (online)"
          else
            echo "âœ— Agent is not running"
            sudo -u iotistic pm2 logs iotistic-agent --nostream --lines 100
            exit 1
          fi

      - name: Test agent API
        run: |
          echo "Testing agent API..."
          
          if curl -f http://localhost:48484/health 2>/dev/null || \
             curl -f http://localhost:48484/v2/device 2>/dev/null; then
            echo "âœ“ Agent API is responding"
          else
            echo "âš  Agent API not responding"
            sudo -u iotistic pm2 logs iotistic-agent --nostream --lines 50
          fi

      - name: Verify auto-reconciliation started
        run: |
          echo "Checking for auto-reconciliation in logs..."
          
          if sudo -u iotistic pm2 logs iotistic-agent --nostream --lines 500 | grep -q "Auto-reconciliation started"; then
            echo "âœ“ Auto-reconciliation started"
          else
            echo "âœ— Auto-reconciliation did not start"
            echo "Full logs:"
            sudo -u iotistic pm2 logs iotistic-agent --nostream --lines 500
            exit 1
          fi

      - name: Show PM2 logs
        if: always()
        run: |
          echo "========================================="
          echo "Agent Logs (PM2):"
          echo "========================================="
          sudo -u iotistic pm2 logs iotistic-agent --nostream --lines 200

      - name: Cleanup
        if: always()
        run: |
          sudo -u iotistic pm2 stop iotistic-agent || true
          sudo -u iotistic pm2 delete iotistic-agent || true

      - name: Generate systemd test summary
        if: always()
        run: |
          echo "# Agent PM2 Process Manager Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Installation" >> $GITHUB_STEP_SUMMARY
          echo "- **Location**: \`/opt/iotistic/agent\`" >> $GITHUB_STEP_SUMMARY
          echo "- **User**: \`iotistic\` (non-root)" >> $GITHUB_STEP_SUMMARY
          echo "- **Process Manager**: PM2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests Performed" >> $GITHUB_STEP_SUMMARY
          echo "1. System dependencies installation (SQLite, Docker, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "2. Agent build and installation" >> $GITHUB_STEP_SUMMARY
          echo "3. PM2 process manager setup" >> $GITHUB_STEP_SUMMARY
          echo "4. Process startup and status check" >> $GITHUB_STEP_SUMMARY
          echo "5. API health verification" >> $GITHUB_STEP_SUMMARY
          echo "6. Auto-reconciliation verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Agent running with PM2 validated successfully!" >> $GITHUB_STEP_SUMMARY

  report:
    name: Generate Reports
    needs: [version, buildx, test-agent-docker, test-agent-systemd]
    runs-on: ubuntu-24.04
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog from $PREV_TAG to HEAD"
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file
          echo "$COMMITS" > changelog.txt
          
          # Save first 20 lines for summary
          echo "$COMMITS" | head -20 > changelog_summary.txt

      - name: Get Docker image size
        id: image_size
        run: |
          # Login to Docker Hub to pull the image
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          
          # Pull the image
          docker pull iotistic/agent:${{ needs.version.outputs.package_version }}
          
          # Get image size
          SIZE_BYTES=$(docker image inspect iotistic/agent:${{ needs.version.outputs.package_version }} --format='{{.Size}}')
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc)
          
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "size_bytes=$SIZE_BYTES" >> $GITHUB_OUTPUT
          
          # Get layer count
          LAYERS=$(docker image inspect iotistic/agent:${{ needs.version.outputs.package_version }} --format='{{len .RootFS.Layers}}')
          echo "layers=$LAYERS" >> $GITHUB_OUTPUT

      - name: Generate Summary Report
        run: |
          echo "# Build & Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Version Information" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.version.outputs.package_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA:** \`${{ needs.version.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ steps.image_size.outputs.size_mb }} MB" >> $GITHUB_STEP_SUMMARY
          echo "**Layers:** ${{ steps.image_size.outputs.layers }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:${{ needs.version.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:${{ needs.version.outputs.package_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat changelog_summary.txt >> $GITHUB_STEP_SUMMARY
          
          TOTAL_COMMITS=$(wc -l < changelog.txt)
          SHOWN_COMMITS=$(wc -l < changelog_summary.txt)
          if [ $TOTAL_COMMITS -gt $SHOWN_COMMITS ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_...and $((TOTAL_COMMITS - SHOWN_COMMITS)) more commits_" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "All jobs completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
