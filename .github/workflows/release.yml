name: Release All Services

on:
  push:
    tags:
      - 'v*.*.*'  # e.g., v1.2.3, v2.0.0
      - 'v*.*'    # e.g., v1.0, v2.1

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-24.04
    outputs:
      api_changed: ${{ steps.changes.outputs.api }}
      housekeeper_changed: ${{ steps.changes.outputs.housekeeper }}
      dashboard_changed: ${{ steps.changes.outputs.dashboard }}
      agent_changed: ${{ steps.changes.outputs.agent }}
      billing_changed: ${{ steps.changes.outputs.billing }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Detect changes since last tag
        id: changes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "Previous tag: $PREV_TAG"
          echo "Current tag: ${GITHUB_REF#refs/tags/}"
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - building all services"
            echo "api=true" >> $GITHUB_OUTPUT
            echo "housekeeper=true" >> $GITHUB_OUTPUT
            echo "dashboard=true" >> $GITHUB_OUTPUT
            echo "agent=true" >> $GITHUB_OUTPUT
            echo "billing=true" >> $GITHUB_OUTPUT
          else
            echo "Checking for changes since $PREV_TAG..."
            
            # Check each service directory for changes
            if git diff --name-only $PREV_TAG HEAD | grep -q '^api/'; then
              echo "API changed"
              echo "api=true" >> $GITHUB_OUTPUT
            else
              echo "API unchanged"
              echo "api=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only $PREV_TAG HEAD | grep -q '^housekeeper/'; then
              echo "Housekeeper changed"
              echo "housekeeper=true" >> $GITHUB_OUTPUT
            else
              echo "Housekeeper unchanged"
              echo "housekeeper=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only $PREV_TAG HEAD | grep -q '^dashboard/'; then
              echo "Dashboard changed"
              echo "dashboard=true" >> $GITHUB_OUTPUT
            else
              echo "Dashboard unchanged"
              echo "dashboard=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only $PREV_TAG HEAD | grep -q '^agent/'; then
              echo "Agent changed"
              echo "agent=true" >> $GITHUB_OUTPUT
            else
              echo "Agent unchanged"
              echo "agent=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only $PREV_TAG HEAD | grep -q '^billing/'; then
              echo "Billing changed"
              echo "billing=true" >> $GITHUB_OUTPUT
            else
              echo "Billing unchanged"
              echo "billing=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Display detection results
        run: |
          echo "## Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.changes.outputs.api }} | ${{ steps.changes.outputs.api == 'true' && 'Build' || 'Retag' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Housekeeper | ${{ steps.changes.outputs.housekeeper }} | ${{ steps.changes.outputs.housekeeper == 'true' && 'Build' || 'Retag' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ steps.changes.outputs.dashboard }} | ${{ steps.changes.outputs.dashboard == 'true' && 'Build' || 'Retag' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | ${{ steps.changes.outputs.agent }} | ${{ steps.changes.outputs.agent == 'true' && 'Build' || 'Retag' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Billing | ${{ steps.changes.outputs.billing }} | ${{ steps.changes.outputs.billing == 'true' && 'Build' || 'Retag' }} |" >> $GITHUB_STEP_SUMMARY

  build-api:
    name: Build API
    needs: detect-changes
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push API (if changed)
        if: needs.detect-changes.outputs.api_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            iotistic/api:latest
            iotistic/api:${{ needs.detect-changes.outputs.version }}
            iotistic/api:${{ github.sha }}

      - name: Retag existing API image (if unchanged)
        if: needs.detect-changes.outputs.api_changed == 'false'
        run: |
          echo "API unchanged - retagging latest image with version ${{ needs.detect-changes.outputs.version }}"
          docker pull iotistic/api:latest
          docker tag iotistic/api:latest iotistic/api:${{ needs.detect-changes.outputs.version }}
          docker push iotistic/api:${{ needs.detect-changes.outputs.version }}

  build-housekeeper:
    name: Build Housekeeper
    needs: detect-changes
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Housekeeper (if changed)
        if: needs.detect-changes.outputs.housekeeper_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./housekeeper
          file: ./housekeeper/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            iotistic/housekeeper:latest
            iotistic/housekeeper:${{ needs.detect-changes.outputs.version }}
            iotistic/housekeeper:${{ github.sha }}

      - name: Retag existing Housekeeper image (if unchanged)
        if: needs.detect-changes.outputs.housekeeper_changed == 'false'
        run: |
          echo "Housekeeper unchanged - retagging latest image with version ${{ needs.detect-changes.outputs.version }}"
          docker pull iotistic/housekeeper:latest
          docker tag iotistic/housekeeper:latest iotistic/housekeeper:${{ needs.detect-changes.outputs.version }}
          docker push iotistic/housekeeper:${{ needs.detect-changes.outputs.version }}

  build-dashboard:
    name: Build Dashboard
    needs: detect-changes
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Dashboard (if changed)
        if: needs.detect-changes.outputs.dashboard_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./dashboard
          file: ./dashboard/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            iotistic/dashboard:latest
            iotistic/dashboard:${{ needs.detect-changes.outputs.version }}
            iotistic/dashboard:${{ github.sha }}

      - name: Retag existing Dashboard image (if unchanged)
        if: needs.detect-changes.outputs.dashboard_changed == 'false'
        run: |
          echo "Dashboard unchanged - retagging latest image with version ${{ needs.detect-changes.outputs.version }}"
          docker pull iotistic/dashboard:latest
          docker tag iotistic/dashboard:latest iotistic/dashboard:${{ needs.detect-changes.outputs.version }}
          docker push iotistic/dashboard:${{ needs.detect-changes.outputs.version }}

  build-agent:
    name: Build Agent
    needs: detect-changes
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Agent (if changed)
        if: needs.detect-changes.outputs.agent_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./agent
          file: ./agent/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          tags: |
            iotistic/agent:latest
            iotistic/agent:${{ needs.detect-changes.outputs.version }}
            iotistic/agent:${{ github.sha }}

      - name: Retag existing Agent image (if unchanged)
        if: needs.detect-changes.outputs.agent_changed == 'false'
        run: |
          echo "Agent unchanged - retagging latest image with version ${{ needs.detect-changes.outputs.version }}"
          docker pull iotistic/agent:latest
          docker tag iotistic/agent:latest iotistic/agent:${{ needs.detect-changes.outputs.version }}
          docker push iotistic/agent:${{ needs.detect-changes.outputs.version }}

  build-billing:
    name: Build Billing
    needs: detect-changes
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Billing (if changed)
        if: needs.detect-changes.outputs.billing_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./billing
          file: ./billing/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            iotistic/billing:latest
            iotistic/billing:${{ needs.detect-changes.outputs.version }}
            iotistic/billing:${{ github.sha }}

      - name: Retag existing Billing image (if unchanged)
        if: needs.detect-changes.outputs.billing_changed == 'false'
        run: |
          echo "Billing unchanged - retagging latest image with version ${{ needs.detect-changes.outputs.version }}"
          docker pull iotistic/billing:latest
          docker tag iotistic/billing:latest iotistic/billing:${{ needs.detect-changes.outputs.version }}
          docker push iotistic/billing:${{ needs.detect-changes.outputs.version }}

  release-summary:
    name: Release Summary
    needs: [detect-changes, build-api, build-housekeeper, build-dashboard, build-agent, build-billing]
    runs-on: ubuntu-24.04
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges | head -50)
          else
            echo "Generating changelog from $PREV_TAG to ${GITHUB_REF#refs/tags/}"
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          echo "$COMMITS" > changelog.txt
          echo "$COMMITS" | head -20 > changelog_summary.txt

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ needs.detect-changes.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false

      - name: Generate Release Summary
        run: |
          echo "# Release ${{ needs.detect-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All services tagged with version \`${{ needs.detect-changes.outputs.version }}\`:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/api:${{ needs.detect-changes.outputs.version }}\` ${{ needs.detect-changes.outputs.api_changed == 'true' && '(rebuilt)' || '(retagged)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/housekeeper:${{ needs.detect-changes.outputs.version }}\` ${{ needs.detect-changes.outputs.housekeeper_changed == 'true' && '(rebuilt)' || '(retagged)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/dashboard:${{ needs.detect-changes.outputs.version }}\` ${{ needs.detect-changes.outputs.dashboard_changed == 'true' && '(rebuilt)' || '(retagged)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/agent:${{ needs.detect-changes.outputs.version }}\` ${{ needs.detect-changes.outputs.agent_changed == 'true' && '(rebuilt)' || '(retagged)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`iotistic/billing:${{ needs.detect-changes.outputs.version }}\` ${{ needs.detect-changes.outputs.billing_changed == 'true' && '(rebuilt)' || '(retagged)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat changelog_summary.txt >> $GITHUB_STEP_SUMMARY
          
          TOTAL=$(wc -l < changelog.txt)
          SHOWN=$(wc -l < changelog_summary.txt)
          if [ $TOTAL -gt $SHOWN ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_...and $((TOTAL - SHOWN)) more commits_" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Update your deployments to use version \`${{ needs.detect-changes.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Kubernetes" >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/api api=iotistic/api:${{ needs.detect-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/housekeeper housekeeper=iotistic/housekeeper:${{ needs.detect-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Docker Compose" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose pull && docker-compose up -d" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
