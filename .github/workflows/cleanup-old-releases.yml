name: Cleanup Old Releases

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      keep_versions:
        description: 'Number of versions to keep'
        required: false
        default: 10
        type: number
      dry_run:
        description: 'Dry run (do not delete)'
        required: false
        default: true
        type: boolean

jobs:
  cleanup-docker-images:
    name: Cleanup Old Docker Images
    runs-on: ubuntu-24.04
    
    steps:
      - name: Set retention parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "keep_versions=${{ github.event.inputs.keep_versions }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "keep_versions=10" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup old Docker images
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          KEEP_VERSIONS: ${{ steps.params.outputs.keep_versions }}
          DRY_RUN: ${{ steps.params.outputs.dry_run }}
        run: |
          echo "Fetching Docker Hub token..."
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_PASSWORD\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to authenticate with Docker Hub"
            exit 1
          fi
          
          echo "Fetching tags for iotistic/agent..."
          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/iotistic/agent/tags?page_size=100" | \
            jq -r '.results[] | select(.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+$")) | .name' | \
            sort -V -r)
          
          TOTAL_TAGS=$(echo "$TAGS" | wc -l)
          echo "Found $TOTAL_TAGS version tags (excluding latest and SHA tags)"
          
          if [ $TOTAL_TAGS -le $KEEP_VERSIONS ]; then
            echo "Only $TOTAL_TAGS tags found, keeping all (threshold: $KEEP_VERSIONS)"
            exit 0
          fi
          
          # Skip the first KEEP_VERSIONS tags, delete the rest
          TAGS_TO_DELETE=$(echo "$TAGS" | tail -n +$((KEEP_VERSIONS + 1)))
          DELETE_COUNT=$(echo "$TAGS_TO_DELETE" | wc -l)
          
          echo "Will delete $DELETE_COUNT old version tags (keeping latest $KEEP_VERSIONS):"
          echo "$TAGS_TO_DELETE"
          echo ""
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "DRY RUN - No images will be deleted"
            echo "$TAGS_TO_DELETE" | while read -r tag; do
              echo "Would delete: iotistic/agent:$tag"
            done
          else
            echo "Deleting old images..."
            DELETED=0
            FAILED=0
            
            echo "$TAGS_TO_DELETE" | while read -r tag; do
              echo "Deleting iotistic/agent:$tag..."
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                -H "Authorization: JWT $TOKEN" \
                "https://hub.docker.com/v2/repositories/iotistic/agent/tags/$tag/")
              
              if [ "$STATUS" = "204" ] || [ "$STATUS" = "200" ]; then
                echo "✓ Deleted $tag"
                DELETED=$((DELETED + 1))
              else
                echo "✗ Failed to delete $tag (HTTP $STATUS)"
                FAILED=$((FAILED + 1))
              fi
            done
            
            echo ""
            echo "Cleanup complete: $DELETED deleted, $FAILED failed"
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "# Docker Image Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`iotistic/agent\`" >> $GITHUB_STEP_SUMMARY
          echo "**Retention Policy:** Keep latest ${{ steps.params.outputs.keep_versions }} versions" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.params.outputs.dry_run == 'true' && 'Dry Run' || 'Live Deletion' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check job logs for detailed deletion results." >> $GITHUB_STEP_SUMMARY

  cleanup-azure-blobs:
    name: Cleanup Old Azure Blobs
    runs-on: ubuntu-24.04
    
    steps:
      - name: Set retention parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "keep_versions=${{ github.event.inputs.keep_versions }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "keep_versions=10" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure Blob lifecycle policy
        run: |
          echo "Configuring lifecycle management policy for scripts container..."
          
          # Create lifecycle policy JSON
          cat > /tmp/lifecycle-policy.json <<'EOF'
          {
            "rules": [
              {
                "enabled": true,
                "name": "delete-old-versioned-scripts",
                "type": "Lifecycle",
                "definition": {
                  "filters": {
                    "blobTypes": ["blockBlob"],
                    "prefixMatch": ["agent/versions/"]
                  },
                  "actions": {
                    "version": {
                      "delete": {
                        "daysAfterCreationGreaterThan": 90
                      }
                    }
                  }
                }
              },
              {
                "enabled": true,
                "name": "delete-old-blob-versions",
                "type": "Lifecycle",
                "definition": {
                  "filters": {
                    "blobTypes": ["blockBlob"],
                    "prefixMatch": ["agent/"]
                  },
                  "actions": {
                    "version": {
                      "delete": {
                        "daysAfterCreationGreaterThan": 30
                      }
                    }
                  }
                }
              }
            ]
          }
          EOF
          
          echo "Getting resource group for storage account..."
          RESOURCE_GROUP=$(az storage account show \
            --name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --query resourceGroup \
            --output tsv)
          
          echo "Resource Group: $RESOURCE_GROUP"
          
          echo "Applying lifecycle policy to storage account..."
          az storage account management-policy create \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --resource-group "$RESOURCE_GROUP" \
            --policy @/tmp/lifecycle-policy.json
          
          echo "✓ Lifecycle policy configured:"
          echo "  - Versioned scripts in agent/versions/: Keep for 90 days"
          echo "  - Blob versions for agent/: Keep for 30 days"
          echo "  - Latest versions: Never deleted automatically"

      - name: Manual cleanup of old versioned scripts
        env:
          KEEP_VERSIONS: ${{ steps.params.outputs.keep_versions }}
          DRY_RUN: ${{ steps.params.outputs.dry_run }}
        run: |
          echo "Fetching versioned scripts from agent/versions/..."
          
          # Get all versioned install-docker scripts
          DOCKER_SCRIPTS=$(az storage blob list \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --prefix agent/versions/install-docker- \
            --query "[?name != 'agent/versions/'].{name:name,created:properties.creationTime}" \
            --output json | \
            jq -r 'sort_by(.created) | reverse | .[].name')
          
          # Get all versioned install-systemd scripts
          SYSTEMD_SCRIPTS=$(az storage blob list \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name scripts \
            --prefix agent/versions/install-systemd- \
            --query "[?name != 'agent/versions/'].{name:name,created:properties.creationTime}" \
            --output json | \
            jq -r 'sort_by(.created) | reverse | .[].name')
          
          # Function to cleanup old versions
          cleanup_versions() {
            local scripts="$1"
            local script_type="$2"
            
            # Filter out .sha256 files for counting
            local main_scripts=$(echo "$scripts" | grep -v '\.sha256$' || true)
            local total=$(echo "$main_scripts" | grep -v '^$' | wc -l)
            
            if [ $total -le $KEEP_VERSIONS ]; then
              echo "Only $total $script_type scripts found, keeping all (threshold: $KEEP_VERSIONS)"
              return
            fi
            
            # Get scripts to delete (skip first KEEP_VERSIONS, delete rest)
            local to_delete=$(echo "$main_scripts" | tail -n +$((KEEP_VERSIONS + 1)))
            local delete_count=$(echo "$to_delete" | grep -v '^$' | wc -l)
            
            echo ""
            echo "Found $total $script_type scripts (keeping latest $KEEP_VERSIONS):"
            echo "$to_delete"
            echo ""
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "DRY RUN - Would delete $delete_count $script_type scripts and their checksums"
            else
              echo "Deleting $delete_count old $script_type scripts..."
              echo "$to_delete" | while read -r blob; do
                if [ -n "$blob" ]; then
                  echo "Deleting $blob..."
                  az storage blob delete \
                    --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
                    --container-name scripts \
                    --name "$blob" \
                    --output none
                  
                  # Also delete the .sha256 checksum file
                  echo "Deleting ${blob}.sha256..."
                  az storage blob delete \
                    --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
                    --container-name scripts \
                    --name "${blob}.sha256" \
                    --output none 2>/dev/null || true
                  
                  echo "✓ Deleted $blob"
                fi
              done
            fi
          }
          
          echo "=== Docker Installation Scripts ==="
          cleanup_versions "$DOCKER_SCRIPTS" "install-docker"
          
          echo ""
          echo "=== Systemd Installation Scripts ==="
          cleanup_versions "$SYSTEMD_SCRIPTS" "install-systemd"

      - name: Generate summary
        if: always()
        run: |
          echo "# Azure Blob Storage Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Account:** \`${{ secrets.AZURE_STORAGE_ACCOUNT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container:** \`scripts\`" >> $GITHUB_STEP_SUMMARY
          echo "**Retention Policy:** Keep latest ${{ steps.params.outputs.keep_versions }} versions" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.params.outputs.dry_run == 'true' && 'Dry Run' || 'Live Deletion' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Lifecycle Policies Configured" >> $GITHUB_STEP_SUMMARY
          echo "- **Versioned scripts** (agent/versions/): Auto-delete after 90 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Blob versions** (agent/): Auto-delete after 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest versions**: Never auto-deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check job logs for detailed deletion results." >> $GITHUB_STEP_SUMMARY
