@startuml Iotistic IoT Platform Architecture
!define RECTANGLE class

skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF
skinparam component {
  BackgroundColor<<edge>> #E3F2FD
  BackgroundColor<<cloud>> #FFF3E0
  BackgroundColor<<billing>> #F3E5F5
  BackgroundColor<<vpn>> #E8F5E9
  BackgroundColor<<database>> #FCE4EC
  BackgroundColor<<monitoring>> #FFF9C4
  BorderColor #37474F
  FontSize 11
}

title Iotistic IoT Platform - Component Architecture

package "Edge Device Stack (Single Tenant)" <<edge>> {
  component "Agent\n(Port 48484)" as EdgeAgent {
    [Container Orchestrator]
    [Docker/K3s Driver]
    [State Reconciler]
    [Device API]
  }
  
  component "Local API\n(Port 3002)" as EdgeAPI {
    [Device Management]
    [MQTT ACL]
    [Neo4j Service]
  }
  
  component "Dashboard\n(Port 3000)" as EdgeDashboard {
    [React UI]
    [Digital Twin View]
    [Real-time Metrics]
  }
  
  component "VPN Client" as EdgeVPN {
    [OpenVPN Client]
    [Certificate Store]
  }
  
  database "PostgreSQL\n(Port 5432)" as EdgeDB <<database>> {
    [Device Shadow]
    [MQTT ACLs]
    [Metrics]
  }
  
  database "Neo4j\n(Port 7687)" as EdgeNeo4j <<database>> {
    [Device Nodes]
    [Space Nodes]
    [Relationships]
  }
  
  component "Mosquitto\n(Port 1883)" as EdgeMQTT {
    [MQTT Broker]
    [PostgreSQL Auth]
  }
}

package "Kubernetes Cluster (Multi-Tenant SaaS)" <<cloud>> {
  
  package "Global: billing" <<billing>> {
    component "Billing API\n(Port 3100)" as BillingAPI {
      [Stripe Integration]
      [K8s Deployment]
      [License Generator]
      [Customer Lifecycle]
    }
    
    database "PostgreSQL\n(Managed RDS)" as BillingDB <<database>> {
      [Customers]
      [Subscriptions]
      [Usage Tracking]
    }
    
    database "Redis" as BillingRedis <<database>> {
      [Deployment Queue]
      [Bull Jobs]
    }
  }
  
  package "Global: vpn-server" <<vpn>> {
    component "OpenVPN Server\n(Port 1194)" as VPNServer {
      [Device Auth]
      [VPN Routing]
      [10.8.0.0/24]
    }
    
    component "Certificate Manager\n(Port 8080)" as CertManager {
      [PKI Management]
      [Cert Issuance]
      [Revocation]
    }
    
    database "PostgreSQL" as VPNDB <<database>> {
      [Device Registry]
      [Certificates]
    }
  }
  
  package "Customer Namespace: customer-{id}" {
    component "Customer API\n(Port 3002)" as CustomerAPI {
      [Device Management]
      [MQTT ACL]
      [Neo4j Integration]
      [License Validator]
    }
    
    component "Customer Dashboard\n(Port 3000)" as CustomerDashboard {
      [React UI]
      [Digital Twin]
      [WebSocket Updates]
    }
    
    database "PostgreSQL\n(Dedicated)" as CustomerDB <<database>> {
      [Device Shadow]
      [MQTT ACLs]
      [Metrics]
    }
    
    component "Mosquitto\n(Port 1883)" as CustomerMQTT {
      [MQTT Broker]
      [PostgreSQL Auth]
    }
    
    database "Redis\n(Port 6379)" as CustomerRedis <<database>> {
      [Real-time Metrics]
      [Bull Queues]
      [Caching]
    }
    
    component "Billing Exporter" as BillingExporter {
      [Device Count]
      [MQTT Messages]
      [Storage Usage]
    }
    
    component "Prometheus" as CustomerPrometheus <<monitoring>> {
      [Time-series DB]
      [Metrics Storage]
      [Shared/Dedicated]
    }
  }
}

' Edge Device Relationships
EdgeAgent --> EdgeAPI : "Manages containers"
EdgeAgent --> EdgeDB : "Reads/writes state"
EdgeAPI --> EdgeDB : "Device data"
EdgeAPI --> EdgeNeo4j : "Graph operations"
EdgeAPI --> EdgeMQTT : "ACL management"
EdgeDashboard --> EdgeAPI : "REST API"
EdgeMQTT --> EdgeDB : "Auth queries"
EdgeVPN --> VPNServer : "VPN tunnel\n(10.8.0.x)"

' Cloud Billing Relationships
BillingAPI --> BillingDB : "Customer/subscription"
BillingAPI --> BillingRedis : "Deployment queue"
BillingAPI ..> CustomerAPI : "Deploys via Helm"

' VPN Server Relationships
VPNServer --> VPNDB : "Device registry"
CertManager --> VPNDB : "Certificate storage"
CertManager --> VPNServer : "Cert deployment"

' Customer Instance Relationships
CustomerAPI --> CustomerDB : "Device data"
CustomerAPI --> CustomerMQTT : "ACL management"
CustomerAPI --> CustomerRedis : "Metrics/cache"
CustomerDashboard --> CustomerAPI : "REST/WebSocket"
CustomerMQTT --> CustomerDB : "Auth queries"
BillingExporter --> CustomerPrometheus : "Push metrics"
BillingExporter --> CustomerAPI : "Collect usage"

' Cross-namespace communication
EdgeVPN ..> CustomerAPI : "Access via VPN"
EdgeVPN ..> CustomerMQTT : "Publish data"

' External Integrations
BillingAPI --> [Stripe API] : "Payments"
EdgeAgent --> CustomerAPI : "Pull target state"

note right of EdgeAgent
  Container Orchestrator
  - Docker Compose
  - K3s Support
  - State reconciliation
  - Container states:
    running/stopped/paused
end note

note right of BillingAPI
  Multi-Tenant SaaS
  - Customer signup
  - Plan management
  - Helm deployment
  - JWT license generation
  - Plans: Starter/Pro/Enterprise
end note

note right of VPNServer
  Secure Device Access
  - Certificate-based auth
  - NAT traversal
  - Per-customer isolation
  - Auto-reconnect
end note

note bottom of CustomerPrometheus
  Monitoring Strategy
  - Starter/Pro: Shared (monitoring namespace)
  - Enterprise: Dedicated (customer namespace)
  - Configurable retention: 30-90 days
  - Grafana dashboards
end note

legend right
  |<#E3F2FD> Edge Device |
  |<#FFF3E0> Cloud Services |
  |<#F3E5F5> Billing |
  |<#E8F5E9> VPN |
  |<#FCE4EC> Database |
  |<#FFF9C4> Monitoring |
endlegend

@enduml
